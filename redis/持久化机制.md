# redis持久化
有三种持久化方式：AOF、RDB、混合持久化(RDB+AOF)
## AOF
记录写的命令到文件里，流程大概是这样：
```c
(1)客户端发送写命令
(2)redis执行写命令
(3)将命令写到aof_buf 缓存区
(4)调用系统io.write将aof_buf缓存的数据写到文件里
(5)第四步其实只是将数据写到系统page cache里，并未真正持久到磁盘
//注意是先执行命令，然后再写到文件和数据库的先写文件策略不一样
```
命令持久化到磁盘有三种策略(控制的是第5步)
```
1.每执行一次写命令，就持久化到磁盘
2.每秒持久化一次
3.由系统决定
```
### AOF重写机制
如果一直把写命令记录到文件里，文件肯定会非常大，所以有一个重写机制，将一些历史无用的命令删除掉  
历史无用的命令如
```c
set name aa
set name bb //此时name aa 是无用的历史命令的
```
重写机制是，将某一时刻的内存数据，转换为命令，然后重新写到aof文件里

## RDB
即把某一时刻的内存状态，记录下来，持久化到磁盘里。  
持久化会另启动一种进程，所以持久并不会阻塞主线程  
持久化样例
```c
save 900 1 //900 秒之内，对数据库进行了至少 1 次修改；
save 300 10 //300 秒之内，对数据库进行了至少 10 次修改；
save 60 10000 //60 秒之内，对数据库进行了至少 10000 次修改。
```
## 混合持久化
为什么会有混合持久这种策略？
```
(1)RDB 优点是数据恢复速度快，但是快照的频率不好把握。频率太低，丢失的数据就会比较多，频率太高，就会影响性能。
(2)AOF 优点是丢失数据少，但是数据恢复不快。
```
混合持久
```
结合rdb+aof的优点:在aof重写日志时，以rdb方式记录下来，这段时间内主线程处理的写命令，会记录到一个缓冲区里，最后将缓冲区的的命令，再追加到文件里，即文件是rdb+aof
```